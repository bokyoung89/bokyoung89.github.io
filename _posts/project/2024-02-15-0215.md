---
published: true
title: "[íŠ¸ëŸ¬ë¸” ìŠˆíŒ…] ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„"
categories:
- pre-order-service
tag:
- pre-order-service

toc: true
toc_label: "ëª©ë¡" 
toc_icon: "bars"
toc_sticky: true

---
> ğŸ‘©ğŸ»â€ğŸ’» ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì¸ì¦ì„ êµ¬í˜„í•œ ê³¼ì •ì„ ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.

## ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì „í™˜ê³¼ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ê³ ë¯¼

ëª¨ë†€ë¦¬ì‹ ì„œë¹„ìŠ¤ë¥¼ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ëª¨ë“ˆí™”í•˜ë©´ì„œ ê° ëª¨ë“ˆì´ ê°€ì ¸ì•¼ í•  ê¸°ëŠ¥ ì™¸ì— ëª¨ë“  ë¡œì§ì„ ì œê±°í•˜ì˜€ë‹¤. ê° ëª¨ë“ˆê°„ì˜ ê´€ê³„ë¥¼ ë¶„ë¦¬í•˜ë©´ì„œ user-serviceì—ì„œ ë‹´ë‹¹í–ˆë˜ ì¸ì¦/ì¸ê°€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë˜ì—ˆë‹¤. í•´ë‹¹ ì‹œìŠ¤í…œì€ ë¡œê·¸ì¸ ì´í›„ ëª¨ë“  API í˜¸ì¶œì— ëŒ€í•´ì„œëŠ” í† í°ì„ ê²€ì¦í•˜ê³  ìˆë‹¤.

### AS-IS ê¸°ì¡´ ëª¨ë†€ë¦¬ì‹ ì˜ˆì•½ êµ¬ë§¤ ì„œë¹„ìŠ¤ì˜ ì¸ì¦ ì ˆì°¨

1. í´ë¼ì´ì–¸íŠ¸ì—ì„œ api ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ user-serviceì˜ JwtTokenFilterê°€ JWT í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•œë‹¤.
2. í† í° ì •ë³´ê°€ ìœ íš¨í•œ ê²½ìš°, DBì—ì„œ ì–»ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì§€ê³  ì¸ì¦ ì •ë³´(authentication)ë¥¼ ì„¤ì •í•œë‹¤.
3. í˜¸ì¶œëœ ë©”ì„œë“œëŠ” authenticationë¥¼ ê°€ì§€ê³  í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

**PostService**

```java
// ê²Œì‹œë¬¼ì„ ìƒì„±í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œ
// ì‚¬ìš©ìê°€ ì¸ì¦ë˜ë©´ ì¸ì¦ ì •ë³´ì¸ authenticationë¥¼ ì „ë‹¬ë°›ëŠ”ë‹¤.
@PostMapping
public Response<Void> create(@RequestBody PostCreateReqeust reqeust, Authentication authentication) {
        // ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì´ë¦„ì„ ì–»ì–´ì™€ ë©”ì„œë“œì— ì „ë‹¬í•œë‹¤.
        postService.create(reqeust.getTitle(), reqeust.getContent(), authentication.getName());
        return Response.success();
        }
```

**JwtTokenFilter**

```java
@Slf4j
@RequiredArgsConstructor
public class JwtTokenFilter extends OncePerRequestFilter {
    
    private final String key;
    private final UserService userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        
        final String header = request.getHeader(HttpHeaders.AUTHORIZATION);

        if (header == null || !header.startsWith("Bearer ")) {
            log.error("Error occurs while getting header. header is null or invalid");
            filterChain.doFilter(request, response);
            return;
        }

        try {
            final String token = header.split(" ")[1].trim();

            // JWT í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•œë‹¤.
            if (JwtTokenUtils.isExpired(token, key)) {
                log.error("Key is expired");
                filterChain.doFilter(request, response);
                return;
            };

            // í† í°ì—ì„œ ì‚¬ìš©ì ì´ë©”ì¼ì„ ì¶”ì¶œí•œë‹¤.
            String email = JwtTokenUtils.getEmail(token, key);
            // ì¶”ì¶œí•œ ì´ë©”ì¼ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•œë‹¤.
            UserAccount userAccount = userService.loadByUserByEmail(email);

            // ì‚¬ìš©ì ì •ë³´ë¡œë¶€í„° Spring Securityì˜ ì¸ì¦ í† í°ì„ ìƒì„±í•œë‹¤.
            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                    userAccount, null, null
            );
            // ìš”ì²­ì— ëŒ€í•œ ì¸ì¦ ì •ë³´ë¥¼ ì„¤ì •í•œë‹¤.
            authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
            SecurityContextHolder.getContext().setAuthentication(authentication);
        } catch (RuntimeException e) {
            log.error("Error occurs while validating : {}", e.toString());
            filterChain.doFilter(request, response);
            return;
        }
        
        filterChain.doFilter(request, response);
    }
}
```

## user-serivceì˜ ì—­í•  ë¶„ë¦¬

ìš°ì„  ì¸ì¦/ì¸ê°€ë¥¼ ê³„ì† `user-service`ì—ê²Œ ìœ„ì„í•  ê²ƒì¸ê°€ë¥¼ ê³ ë¯¼í–ˆë‹¤. `user-serivce`ëŠ” íšŒì›ê°€ì…, ë¡œê·¸ì¸, í”„ë¡œí•„ ì¡°íšŒ, ìˆ˜ì • ê¸°ëŠ¥ë§Œì„ ì£¼ê¸°ë¡œ ê²°ì •í–ˆê¸°ì— ì¸ì¦ì€ ë‹¹ì—°íˆ `user-service`ì˜ ì—­í• ì´ ë˜ì–´ì„  ì•ˆëë‹¤. ê·¸ë ‡ë‹¤ë©´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì¡°ì—ì„œ ì¸ì¦/ì¸ê°€ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œ?

ë‚´ í”„ë¡œì íŠ¸ì˜ ê²½ìš° ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ìš”ì²­ì€ ì¸ì¦ ì ˆì°¨ë¥¼ ê±°ì³ì•¼ í–ˆê¸°ì— ì„œë¹„ìŠ¤ ìµœì „ë°©ì— ìœ„ì¹˜í•œ API Gatewayë¥¼ í†µí•´ ì¸ì¦ ì ˆì°¨ë¥¼ ìœ„ì„í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì í•©í•˜ë‹¤ê³  íŒë‹¨í•˜ì˜€ë‹¤. í•˜ì§€ë§Œ ë‚´ê°€ ì•”í˜¸í™”í•œ Bcrypt ì•Œê³ ë¦¬ì¦˜ì€ ë‹¨ë°©í–¥ hashì´ê¸° ë•Œë¬¸ì— ë³µí˜¸í™”ê°€ ë¶ˆê°€ëŠ¥í•œ ë¬¸ì œê°€ ìˆì—ˆë‹¤.

jwt.io ì‚¬ì´íŠ¸ë¥¼ í†µí•´ ë””ì½”ë”©ì´ ê°€ëŠ¥í•œ ê²ƒì„ í™•ì¸í–ˆê³ , spring cloud gatewayì˜ customfilterë¥¼ êµ¬í˜„í•´ íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì´í›„ì— ë°œìƒí•˜ëŠ” ëª¨ë“  API í˜¸ì¶œì€ ì¸ì¦ì„ ê±°ì¹˜ë„ë¡ í•˜ì˜€ë‹¤. user-serviceëŠ” íšŒì›ê°€ì…ë„ ë¡œê·¸ì¸ ì‹œ í† í° ë°œê¸‰ ê¸°ëŠ¥ë§Œ ë‚¨ê²¨ë‘ì—ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œëŠ” ì˜ë„í•œëŒ€ë¡œ ì„œë¹„ìŠ¤ ê°„ì˜ ì—­í• ì„ ë¶„ë¦¬í•  ìˆ˜ ìˆì—ˆë‹¤.

### TO-BE ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì˜ˆì•½ êµ¬ë§¤ ì„œë¹„ìŠ¤ì˜ ì¸ì¦ ì ˆì°¨

1. í¬ìŠ¤íŠ¸ ì‘ì„± APIë¥¼ ìš”ì²­í•œë‹¤. Headerì— í† í° ì •ë³´ë¥¼ ë‹´ê³  ìˆë‹¤.
2. Gatewayì—ì„œ í† í°ì˜ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì§„í–‰í•œë‹¤.
3. í† í°ì´ ìœ íš¨í•˜ë©´ APIê°€ ì •ìƒì ìœ¼ë¡œ í˜¸ì¶œë˜ê³  ì´í›„ ê¸°ëŠ¥ì„ ì§„í–‰í•œë‹¤.

---

### reference
[https://medium.com/spoontech/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B5%AC%EC%A1%B0-msa-%EC%9D%98-%EC%9D%B8%EC%A6%9D-%EB%B0%8F-%EC%9D%B8%EA%B0%80-authorization-authentication-a595179ab88e](https://medium.com/spoontech/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B5%AC%EC%A1%B0-msa-%EC%9D%98-%EC%9D%B8%EC%A6%9D-%EB%B0%8F-%EC%9D%B8%EA%B0%80-authorization-authentication-a595179ab88e)