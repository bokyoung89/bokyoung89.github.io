---
published: true
title: "[íŠ¸ëŸ¬ë¸” ìŠˆíŒ…] ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„"
categories:
- pre-order-service
tag:
- pre-order-service

toc: true
toc_label: "ëª©ë¡" 
toc_icon: "bars"
toc_sticky: true

---
> ğŸ‘©ğŸ»â€ğŸ’» ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì¸ì¦ì„ êµ¬í˜„í•œ ê³¼ì •ì„ ê¸°ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.

## ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì „í™˜ê³¼ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ê³ ë¯¼

ëª¨ë†€ë¦¬ì‹ ì„œë¹„ìŠ¤ë¥¼ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ëª¨ë“ˆí™”í•˜ë©´ì„œ ê° ëª¨ë“ˆì´ ê°€ì ¸ì•¼ í•  ê¸°ëŠ¥ ì™¸ì— ëª¨ë“  ë¡œì§ì„ ì œê±°í•˜ì˜€ë‹¤. ê° ëª¨ë“ˆê°„ì˜ ê´€ê³„ë¥¼ ë¶„ë¦¬í•˜ë©´ì„œ `user-service`ì—ì„œ ë‹´ë‹¹í–ˆë˜ ì¸ì¦/ì¸ê°€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë˜ì—ˆë‹¤. í•´ë‹¹ ì‹œìŠ¤í…œì€ ë¡œê·¸ì¸ ì´í›„ ëª¨ë“  API í˜¸ì¶œì— ëŒ€í•´ì„œëŠ” í† í°ì„ ê²€ì¦í•˜ê³  ìˆë‹¤.

### AS-IS ê¸°ì¡´ ëª¨ë†€ë¦¬ì‹ ì˜ˆì•½ êµ¬ë§¤ ì„œë¹„ìŠ¤ì˜ ì¸ì¦ ì ˆì°¨

1. í´ë¼ì´ì–¸íŠ¸ì—ì„œ api ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ user-serviceì˜ JwtTokenFilterê°€ JWT í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•œë‹¤.
2. í† í° ì •ë³´ê°€ ìœ íš¨í•œ ê²½ìš°, DBì—ì„œ ì–»ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì§€ê³  ì¸ì¦ ì •ë³´(authentication)ë¥¼ ì„¤ì •í•œë‹¤.
3. ì„œë¹„ìŠ¤ëŠ” ì „ë‹¬ë°›ì€ ì¸ì¦ ì •ë³´(authentication)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•œë‹¤.

```java
[PostService.java]
// ê²Œì‹œë¬¼ì„ ìƒì„±í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œ
// ì‚¬ìš©ìê°€ ì¸ì¦ë˜ë©´ ì¸ì¦ ì •ë³´ì¸ authenticationë¥¼ ì „ë‹¬ë°›ëŠ”ë‹¤.
@PostMapping
public Response<Void> create(@RequestBody PostCreateReqeust reqeust, Authentication authentication) {
        // ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì´ë¦„ì„ ì–»ì–´ì™€ ë©”ì„œë“œì— ì „ë‹¬í•œë‹¤.
        postService.create(reqeust.getTitle(), reqeust.getContent(), authentication.getName());
        return Response.success();
        }
```

```java
@Slf4j
@RequiredArgsConstructor
public class JwtTokenFilter extends OncePerRequestFilter {
    
    private final String key;
    private final UserService userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        
        final String header = request.getHeader(HttpHeaders.AUTHORIZATION);

        if (header == null || !header.startsWith("Bearer ")) {
            log.error("Error occurs while getting header. header is null or invalid");
            filterChain.doFilter(request, response);
            return;
        }

        try {
            final String token = header.split(" ")[1].trim();

            // JWT í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•œë‹¤.
            if (JwtTokenUtils.isExpired(token, key)) {
                log.error("Key is expired");
                filterChain.doFilter(request, response);
                return;
            };

            // í† í°ì—ì„œ ì‚¬ìš©ì ì´ë©”ì¼ì„ ì¶”ì¶œí•œë‹¤.
            String email = JwtTokenUtils.getEmail(token, key);
            // ì¶”ì¶œí•œ ì´ë©”ì¼ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•œë‹¤.
            UserAccount userAccount = userService.loadByUserByEmail(email);

            // ì‚¬ìš©ì ì •ë³´ë¡œë¶€í„° Spring Securityì˜ ì¸ì¦ í† í°ì„ ìƒì„±í•œë‹¤.
            UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                    userAccount, null, null
            );
            // ìš”ì²­ì— ëŒ€í•œ ì¸ì¦ ì •ë³´ë¥¼ ì„¤ì •í•œë‹¤.
            authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
            SecurityContextHolder.getContext().setAuthentication(authentication);
        } catch (RuntimeException e) {
            log.error("Error occurs while validating : {}", e.toString());
            filterChain.doFilter(request, response);
            return;
        }
        
        filterChain.doFilter(request, response);
    }
}
```

## user-serivceì˜ ì—­í•  ë¶„ë¦¬

ìš°ì„  ì¸ì¦/ì¸ê°€ë¥¼ ê³„ì† `user-service`ì—ê²Œ ìœ„ì„í•  ê²ƒì¸ê°€ë¥¼ ê³ ë¯¼í–ˆë‹¤. `user-serivce`ëŠ” íšŒì›ê°€ì…, ë¡œê·¸ì¸, í”„ë¡œí•„ ì¡°íšŒ, ìˆ˜ì • ê¸°ëŠ¥ë§Œì„ ì£¼ê¸°ë¡œ ê²°ì •í–ˆê¸°ì— ì¸ì¦ì€ ë‹¹ì—°íˆ `user-service`ì˜ ì—­í• ì´ ë˜ì–´ì„  ì•ˆëë‹¤. ê·¸ë ‡ë‹¤ë©´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì¡°ì—ì„œ ì¸ì¦/ì¸ê°€ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œ?

ë‚´ í”„ë¡œì íŠ¸ì˜ ê²½ìš° ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ìš”ì²­ì€ ì¸ì¦ ì ˆì°¨ë¥¼ ê±°ì³ì•¼ í–ˆê¸°ì— ì„œë¹„ìŠ¤ ìµœì „ë°©ì— ìœ„ì¹˜í•œ API Gatewayë¥¼ í†µí•´ ì¸ì¦ ì ˆì°¨ë¥¼ ìœ„ì„í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì í•©í•˜ë‹¤ê³  íŒë‹¨í•˜ì˜€ë‹¤.

Spring Cloud Gatewayì˜ customfilterë¥¼ êµ¬í˜„í•´ íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì´í›„ì— ë°œìƒí•˜ëŠ” ëª¨ë“  API í˜¸ì¶œì€ ì¸ì¦ì„ ê±°ì¹˜ë„ë¡ í•˜ì˜€ë‹¤. `user-service`ëŠ” íšŒì›ê°€ì…ë„ ë¡œê·¸ì¸ ì‹œ í† í° ë°œê¸‰ ê¸°ëŠ¥ë§Œ ë‚¨ê²¨ë‘ì—ˆë‹¤.

### TO-BE ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì˜ˆì•½ êµ¬ë§¤ ì„œë¹„ìŠ¤ì˜ ì¸ì¦ ì ˆì°¨

1. í´ë¼ì´ì–¸íŠ¸ì—ì„œ api ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ API Gatewayì˜ AuthorizationHeaderFilterê°€ JWT í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•œë‹¤.
2. í† í° ì •ë³´ê°€ ìœ íš¨í•œ ê²½ìš°, ì‚¬ìš©ì IDë¥¼ ìš”ì²­ í—¤ë”ì— ì¶”ê°€í•˜ì—¬ ì„œë¹„ìŠ¤ì— ì „ë‹¬í•œë‹¤.
3. ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ì IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•œë‹¤.

### êµ¬í˜„ ê³¼ì •
**1. ì˜ì¡´ì„± ì¶”ê°€**
* JWTë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ JJWTë¥¼ ì¶”ê°€í•œë‹¤.

```yaml
dependencies {
    ...
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
    implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
    ...
}
```
<br />

**2. JWT ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ ìƒì„±**
* JWT í† í°ì—ì„œ í•„ìš”í•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³  ê²€ì¦í•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë©”ì„œë“œë¥¼ êµ¬í˜„í•œë‹¤.

```java
public class JwtTokenUtils {

    // í† í°ì—ì„œ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•˜ëŠ” ë©”ì„œë“œ
    public static String getUserId(String token, String key) {
        return extractClaims(token, key).getSubject();
    }

    // í† í°ì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
    public static boolean isExpired(String token, String key) {
        // í† í°ì˜ ë§Œë£Œì¼ì„ ì¶”ì¶œí•˜ì—¬ í˜„ì¬ ì‹œê°„ê³¼ ë¹„êµí•˜ì—¬ ë§Œë£Œ ì—¬ë¶€ë¥¼ ë°˜í™˜
        Date expiredDate = extractClaims(token, key).getExpiration();
        return expiredDate.before(new Date());
    }

    // í† í°ì—ì„œ í´ë ˆì„ì„ ì¶”ì¶œí•˜ëŠ” ë©”ì„œë“œ
    private static Claims extractClaims(String token, String key) {
        // ì£¼ì–´ì§„ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ JWT í† í°ì„ ê²€ì¦í•˜ê³ , ê²€ì¦ëœ í˜ì´ë¡œë“œ(Claims)ë¥¼ ë°˜í™˜
        return Jwts.parser().verifyWith((SecretKey) getKey(key))
                .build().parseSignedClaims(token).getPayload();
    }

    // ì£¼ì–´ì§„ í‚¤ë¡œë¶€í„° SecretKeySpec ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë©”ì„œë“œ
    private static Key getKey(String key) {
        // ì£¼ì–´ì§„ í‚¤ë¥¼ UTF-8 ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ SecretKeySpec ê°ì²´ ìƒì„±
        return new SecretKeySpec(key.getBytes(StandardCharsets.UTF_8), Jwts.SIG.HS256.key().build().getAlgorithm());
    }
}

```

<br />

**3. Filter êµ¬í˜„**
* AbstractGatewayFilterFactoryë¥¼ ìƒì†í•˜ê³ , apply ë©”ì†Œë“œë¥¼ êµ¬í˜„í•œë‹¤.

```java
public class AuthorizationHeaderFilter extends AbstractGatewayFilterFactory<AuthorizationHeaderFilter.Config> {
    @Value("${jwt.secret-key}")
    private String key;
    Environment env;

    public AuthorizationHeaderFilter(Environment env) {
        super(Config.class);
        this.env = env;
    }

    // apply ë©”ì„œë“œëŠ” GatewayFilterë¥¼ ë°˜í™˜í•˜ë©°, ì´ í•„í„°ë¥¼ ì ìš©í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤.
    @Override
    public GatewayFilter apply(Config config) {
        return ((exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();
            /// ìš”ì²­ í—¤ë”ì— Authorization í—¤ë”ê°€ ì—†ëŠ” ê²½ìš°, 401 Unauthorized ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•œë‹¤.
            if (!request.getHeaders().containsKey(HttpHeaders.AUTHORIZATION)) {
                return onError(exchange, "Error occurs while getting header. header is null", HttpStatus.UNAUTHORIZED);
            }

            // ìš”ì²­ í—¤ë”ì—ì„œ Authorization í—¤ë” ê°’ì„ ì¶”ì¶œí•˜ì—¬ JWT í† í°ì„ ì–»ëŠ”ë‹¤.
            // JWT í† í°ì„ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•œë‹¤.
            String authorizationHeader = request.getHeaders().get(HttpHeaders.AUTHORIZATION).get(0);
            String token = authorizationHeader.split(" ")[1].trim();
            String userId = JwtTokenUtils.getUserId(token, key);

            // JWT í† í°ì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.
            // í† í°ì´ ë§Œë£Œëœ ê²½ìš°, 401 Unauthorized ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•œë‹¤.
            if(JwtTokenUtils.isExpired(token, key)) {
                return onError(exchange, "Key is expired", HttpStatus.UNAUTHORIZED);
            }

            // ìš”ì²­ì— principalId í—¤ë”ë¥¼ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ì IDë¥¼ ì „ë‹¬í•œë‹¤.
            request = request.mutate()
                    .header("principalId", userId)
                    .build();

            // ìš”ì²­ í—¤ë”ë¥¼ ë¡œê¹…í•œë‹¤.
            log.info("RequestHeader: {}", request.getHeaders());

            // ìš”ì²­ì„ í•„í„° ì²´ì¸ì— ì „ë‹¬í•œë‹¤.
            return chain.filter(exchange.mutate()
                    .request(request)
                    .build());
        });
    }

    //Mono, Flux -> Spring WebFlux : í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ ë°˜í™˜í•´ì£¼ëŠ” ë°ì´í„° íƒ€ì…. ë‹¨ì¼ ê°’ì´ë©´ Mono, ë‹¤ì¤‘ê°’ì´ë©´ Flux ì‚¬ìš©
    private Mono<Void> onError(ServerWebExchange exchange, String err, HttpStatus httpStatus) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(httpStatus);

        log.error(err);
        return response.setComplete();
    }
    
    ...
```

<br />

**4.application.yml êµ¬ì„±**
* AuthoriztionHeaderFilterë¥¼ ì¶”ê°€í•˜ì—¬ Filterë¥¼ ì ìš©í•  ìš”ì²­ì„ ì§€ì •í•œë‹¤.

```yaml
...
        # activity-service
        - id: activity-service
          uri: lb://ACTIVITY-SERVICE
          predicates:
            - Path=/activity-service/**
          filters:
            - RewritePath=/activity-service/(?<segment>.*),/api/v1/$\{segment}
            - AuthorizationHeaderFilter
...
```

## ë§ˆë¬´ë¦¬
ê²°ê³¼ì ìœ¼ë¡œ API Gatewayì—ì„œ ê³µí†µ ì¸ì¦ ì ˆì°¨ë¥¼ ìˆ˜í–‰í•¨ìœ¼ë¡œì¨ ë’·ë‹¨ì˜ ì„œë¹„ìŠ¤ë“¤ì€ ì¸ì¦ ë°©ì‹ìœ¼ë¡œë¶€í„° ì™„ì „íˆ ë…ë¦½ë˜ì–´ ì¸ì¦ ì„œë¹„ìŠ¤ì™€ì˜ ì˜ì¡´ì„±ì´ ì‚¬ë¼ì§€ê²Œ ë˜ì—ˆê³ , í† í° ë°œê¸‰ / ì¸ì¦ì˜ ì—­í•  ë¶„ë¦¬ë„ ê°€ëŠ¥í•´ì¡Œë‹¤.

---

## reference
[ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì¡°(MSA)ì˜ ì¸ì¦ ë° ì¸ê°€(Authorization & Authentication)](https://medium.com/spoontech/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B5%AC%EC%A1%B0-msa-%EC%9D%98-%EC%9D%B8%EC%A6%9D-%EB%B0%8F-%EC%9D%B8%EA%B0%80-authorization-authentication-a595179ab88e)