---
published: true
title: "[SpringBoot] SQL Scriptsë¥¼ ì‚¬ìš©í•˜ì—¬ H2 Database ì´ˆê¸°í™”í•˜ê¸°"
categories: 
- Spring
tag:
- Spring

toc: true
toc_label: "ëª©ë¡"
toc_icon: "bars"
toc_sticky: true

---
> ğŸ‘©ğŸ»â€ğŸ’» SQL Scriptsë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•œ ê³¼ì •ì„ ê¸°ë¡í•œë‹¤.

DB í…Œì´ë¸”ê³¼ ë°ì´í„°ë¥¼ ì´ˆê¸°ì— ìƒì„±í•´ì•¼í•˜ëŠ” í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê²Œ ë˜ì—ˆë‹¤. ë¡œì»¬ê³¼ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ êµ¬ë™í•  ê²ƒì´ë¯€ë¡œ DBëŠ” in-memoryì¸ H2ë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.
[Spring Boot í™˜ê²½ì—ì„œ DBë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ë°©ë²•](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization)ì€ JPA, Hibernate, SQL Script ë“± ì‚¬ìš©í•˜ëŠ” ê¸°ìˆ  ìŠ¤íƒì— ë”°ë¼ ë‹¤ì–‘í–ˆëŠ”ë°,
ë‚´ í”„ë¡œì íŠ¸ëŠ” hibernateë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´ DDL ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í–ˆë‹¤. 

## hibernateë¡œ h2 Database ì´ˆê¸°í™” ë°©ë²•

### 1. Spring Data JPAì™€ H2 ì˜ì¡´ì„±ì„ ì¶”ê°€í•œë‹¤.
```yaml
//ìƒëµ

implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
runtimeOnly 'com.h2database:h2'

//ìƒëµ
```

### 2. application.properties ë˜ëŠ” application.yml íŒŒì¼ì— h2 DBì— ê´€ë ¨ëœ ì„¤ì •ì„ ì¶”ê°€í•œë‹¤.
```yaml
    spring:
      datasource:
        url: jdbc:h2:mem:test
        username: sa
        password:
        driver-class-name: org.h2.Driver
      h2:
        console:
          enabled: true
          path: /h2-console
      jpa:
        hibernate:
          ddl-auto: create
        properties:
          hibernate:
            format_sql: true
            show_sql: true
        defer:
          datasource:
            initialization: true
```
application.yml íŒŒì¼ì˜ ì£¼ìš” ì†ì„±ì€ ì•„ë˜ì™€ ê°™ë‹¤.
* **spring.datasource.url**
  * H2 DatabaseëŠ” urlì„ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“œë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.
  * In-memory ëª¨ë“œ : `jdbc:h2:mem:<databaseName>`
  * mbedded (ë¡œì»¬) ëª¨ë“œ : `jdbc:h2:~/test` ë˜ëŠ” `jdbc:h2:[file:][<path>]<databaseName>`
  * mbedded ëª¨ë“œëŠ” WAS êµ¬ë™ ì‹œ DB ë°ì´í„°ë¥¼ ë¡œì»¬ì— ì €ì¥í•˜ëŠ” ë°©ì‹ì´ë‹¤. In-Memoryì™€ ë‹¬ë¦¬ ë¹„íœ˜ë°œì„±ì´ë¯€ë¡œ ë°ì´í„° ì†ì‹¤ì„ ë°©ì§€í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ë‚´ í”„ë¡œì íŠ¸ì—ì„œëŠ” In-memory ë°©ì‹ì„ ì‚¬ìš©í–ˆë‹¤.
* **username, password**
  * ê¸°ë³¸ì ìœ¼ë¡œ Spring BootëŠ” `username:sa`ì™€ ë¹ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ë‚´ ì €ì¥ì†Œì— ì—°ê²°í•œë‹¤.
* **h2.console.enabled: true**
  * H2 ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” GUI ì½˜ì†”ì´ ë‚´ì¥ë˜ì–´ ìˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ H2 ì½˜ì†”ì€ Springì—ì„œ í™œì„±í™”ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•´ë‹¹ ì†ì„±ì„ ì¶”ê°€í•´ì•¼ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤.
  * H2 GUI ì ‘ì† url : http://localhost:8080/h2-console
* **jpa.hibernate.ddl-auto**
  * DDL ì¿¼ë¦¬ì˜ ìˆ˜í–‰ ë°©ì‹ì„ ì§€ì •í•œë‹¤. 
    * create: ê¸°ì¡´ í…Œì´ë¸”ì„ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ìƒì„±í•œë‹¤.
    * create-drop: createì™€ ë™ì¼í•˜ë‚˜, ì¢…ë£Œ ì‹œì ì— í…Œì´ë¸”ì„ ì œê±°í•œë‹¤.
    * update: ë³€ê²½ë¶€ë¶„ë§Œ ë°˜ì˜í•œë‹¤.
    * validate: ì—”í„°í‹°ì™€ í…Œì´ë¸”ì´ ì •ìƒ ë§¤í•‘ëœ ê²ƒì¸ì§€ë§Œ í™•ì¸í•œë‹¤.
    * none: ì—”í„°í‹°ë¥¼ í†µí•œ ìë™ìƒì„±ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , schema.sql íŒŒì¼ì´ ìˆëŠ”ê²½ìš° í•´ë‹¹ íŒŒì¼ì„ ì‚¬ìš©í•œë‹¤.
* **format_sql: true / show_sql: true**
  * DBì— ë‚ ë¦¬ëŠ” ëª¨ë“  ì¿¼ë¦¬ë¥¼ í¬ë§·íŒ…í•´ì„œ ë³´ê¸° ìœ„í•´ ì¶”ê°€í–ˆë‹¤.
* **defer.datasource.initialization**
  * ê¸°ë³¸ì ìœ¼ë¡œ Hibernate ì´ˆê¸°í™” ì „ì— data.sql ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ëœë‹¤. ë”°ë¼ì„œ Hibernateì— ì˜í•´ ìƒì„±ëœ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ í•´ë‹¹ ì†ì„±ì„ ì¶”ê°€í•´ì•¼í•œë‹¤. 
  * ê³µì‹ ë¬¸ì„œì— ë”°ë¥´ë©´ DB ì´ˆê¸°í™” ê¸°ìˆ ì„ í˜¼í•©í•˜ëŠ” ê²ƒì€ ê¶Œì¥í•˜ì§€ ì•ŠëŠ” ë°©ì‹ì´ë‹¤. í˜„ì¬ ë²„ì „ì€ Hibernateì™€ SQL Scriptsë¥¼ í˜¼í•©í•œ ë°©ì‹ì´ë‹¤.

### 3. entity í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.

```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class Item {
  @Id
  @Column(name = "item_id")
  private Long id;

  private String name;

  private int price;

  private int stockQuantity;

  @Builder
  public Item(Long id, String name, int price, int stockQuantity) {
    this.id = id;
    this.name = name;
    this.price = price;
    this.stockQuantity = stockQuantity;
  }
}
```

### 4. H2 DBì— insertí•  ë°ì´í„° ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
src/main/resources ë””ë ‰í„°ë¦¬ì— import.sql íŒŒì¼ì„ ì¶”ê°€í•˜ê³  insertë¬¸ì„ ì‘ì„±í•œë‹¤. <br /> 
ì£¼ì˜í•  ì ì€ hibernateë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•˜ëŠ” ê²½ìš°, íŒŒì¼ëª…ì´ **import.sql**ì´ì–´ì•¼ í•œë‹¤. ì²˜ìŒì— SQL Script ë°©ì‹ì„ ë”°ë¼ data.sqlë¡œ ìƒì„±í–ˆë”ë‹ˆ í…Œì´ë¸”ë§Œ ìƒì„±ë˜ê³  ë°ì´í„°ëŠ” ë¹„ì–´ìˆì—ˆë‹¤.

```sql
INSERT INTO item (item_id, name, price, stock_quantity) VALUES (768848, 'ì˜¤ë¦¬í„¸ ì ë°”', 21000, 45);
INSERT INTO item (item_id, name, price, stock_quantity) VALUES (748943, 'ì ì˜· ì„¸íŠ¸', 19000, 89);
INSERT INTO item (item_id, name, price, stock_quantity) VALUES (779989, 'ë‚¨ì„± ë°˜íŒ”í‹°', 35000, 43);
```

### 5. IDEì™€ H2 GUIì—ì„œ ë°ì´í„° ìƒì„±ì„ í™•ì¸í•œë‹¤.
ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ë©´ IDE ì½˜ì†”ì—ì„œ DDL ì¿¼ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì¿¼ë¦¬ ìˆ˜í–‰ ë°©ì‹ì„ createë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— drop ì´í›„ createê°€ ì‹¤í–‰ëœë‹¤.

![image](https://github.com/bokyoung89/Pharmacy-Recommendation-Version-Management/assets/58727604/2d1cd508-aef7-4df5-8d87-3cab87d67865)

ymlì— H2 GUIì„ í™œì„±í™”í•˜ê³  pathë¥¼ /h2-consoleë¡œ ì§€ì •í–ˆìœ¼ë¯€ë¡œ **localhost:8080/h2-console**ë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤. ì´ˆê¸° ì ‘ì† í™”ë©´ì´ ëœ¨ê³ , passwordëŠ” ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ Conncetë¥¼ ëˆŒëŸ¬ H2 DBì— ì ‘ì†í•œë‹¤. 

![image](https://github.com/bokyoung89/Pharmacy-Recommendation-Version-Management/assets/58727604/c9f5192d-5804-4e82-b242-8155b9eeacd4)

selectë¬¸ìœ¼ë¡œ ì¡°íšŒí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë°ì´í„°ê°€ ì˜ ìƒì„±ë˜ì—ˆë‹¤.

![image](https://github.com/bokyoung89/Pharmacy-Recommendation-Version-Management/assets/58727604/a4e4a86b-bb6b-4930-9d9f-083616d971d2)

ê·¸ëŸ°ë° ë‚œ ë¶„ëª…íˆ entity í´ë˜ìŠ¤ë¥¼ id ë¨¼ì € ì‘ì„±í–ˆëŠ”ë° ì™œ ì»¬ëŸ¼ ìˆœì„œê°€ ì œë©‹ëŒ€ë¡œ ìƒì„±ë˜ì—ˆì§€? Spring Data JPAëŠ” í…Œì´ë¸”ì„ ìƒì„±í•  ë•Œ ì»¬ëŸ¼ì„ ì•ŒíŒŒë²³ ìˆœìœ¼ë¡œ ìë™ ì •ë ¬í•´ì¤€ë‹¤ê³  í•œë‹¤.
ë”°ë¼ì„œ ê°œë°œìê°€ ì„¤ê³„í•œ ëŒ€ë¡œ ì»¬ëŸ¼ ìˆœì„œë¥¼ ì •í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒ. ì‹¤ì œë¼ë©´ ê¸°íšëŒ€ë¡œ ì„¤ê³„ê°€ ì•ˆëœ ê²ƒì´ê¸° ë•Œë¬¸ì—, DDLë¬¸ë„ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‘ì„±í•´ì„œ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±í•˜ê¸°ë¡œ í–ˆë‹¤. ë‹¤í–‰íˆ ë³€ê²½í•  ê³³ì€ ë§ì§€ ì•Šì•˜ë‹¤.

## SQL scriptì„ ì‚¬ìš©í•œ h2 DB ì´ˆê¸°í™” ë°©ë²•
### 1. application.ymlì— ddl-autoë¥¼ noneìœ¼ë¡œ ë³€ê²½í•œë‹¤.
noneìœ¼ë¡œ ì„¤ì •í•˜ë©´ ìŠ¤í‚¤ë§ˆ ìƒì„±ì„ hibernateê°€ ì•„ë‹ˆë¼ **schema.sql** íŒŒì¼ì´ ë‹´ë‹¹í•˜ê²Œ ëœë‹¤.
hibernateë¡œ DBë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•Šì„ ê²ƒì´ë¯€ë¡œ defer.datasource.initializationì€ ì œê±° ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬í•œë‹¤.

```yaml
spring:
  datasource:
    url: jdbc:h2:mem:test
    username: sa
    password:
    driver-class-name: org.h2.Driver
  h2:
    console:
      enabled: true
      path: /h2-console
  jpa:
    hibernate:
      ddl-auto: none //createì—ì„œ noneìœ¼ë¡œ ìˆ˜ì •
    properties:
      hibernate:
        format_sql: true
        show_sql: true
#    defer:
#      datasource:
#        initialization: true //ì£¼ì„ ì²˜ë¦¬ë¡œ SQL Scripts ë°©ì‹ ì‚¬ìš©
```

### 2. ìŠ¤í‚¤ë§ˆ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
* src/main/resourcesì— **schema.sql** íŒŒì¼ì„ ì¶”ê°€í•˜ê³  ì•„ë˜ì™€ ê°™ì´ createë¬¸ì„ ì‘ì„±í•œë‹¤.

```sql
CREATE TABLE item
(
    item_id bigint NOT NULL PRIMARY KEY,
    name varchar(255) NOT NULL,
    price integer NOT NULL,
    stock_quantity integer NOT NULL
);
```

### 3. ë°ì´í„° ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ëª…ì„ import.sqlì—ì„œ data.sqlë¡œ ë³€ê²½í•œë‹¤.
* ì•ì„œ ì„¤ëª…í–ˆë“¯ì´ SQL Scripts ì´ˆê¸°í™” ë°©ì‹ì—ì„œëŠ” data.sqlì„ ì°¾ì•„ ë°ì´í„°ë¥¼ ìƒì„±í•œë‹¤.
* ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•´ë³´ë©´ hibernateì˜ DDL ì¿¼ë¦¬ëŠ” ì‹¤í–‰ë˜ì§€ ì•Šê³ , H2 Consoleì—ëŠ” í…Œì´ë¸”ê³¼ ë°ì´í„°ê°€ ì˜ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/bokyoung89/Pharmacy-Recommendation-Version-Management/assets/58727604/232ae1f8-831d-41df-b143-61fad62b2806)

![image](https://github.com/bokyoung89/Pharmacy-Recommendation-Version-Management/assets/58727604/a4e4a86b-bb6b-4930-9d9f-083616d971d2)


### reference

[https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization)
[https://www.sktenterprise.com/bizInsight/blogDetail/dev/6795](https://www.sktenterprise.com/bizInsight/blogDetail/dev/6795)

